{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Driver Tracking</h2>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="driver-select">Select Driver:</label>
                    <select id="driver-select" class="form-control">
                        <option value="">All Drivers</option>
                        {% for driver in drivers %}
                            <option value="{{ driver.id }}">{{ driver.user.first_name }} {{ driver.user.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="status-select">Status:</label>
                    <select id="status-select" class="form-control">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on_trip">On Trip</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="map-container" style="height: 600px; width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
            <div id="map" style="height: 100%; width: 100%;"></div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h4>Active Drivers</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Current Trip</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-table-body">
                            {% for driver in active_drivers %}
                            <tr data-driver-id="{{ driver.id }}">
                                <td>{{ driver.user.first_name }} {{ driver.user.last_name }}</td>
                                <td>
                                    <span class="badge badge-{% if driver.status == 'active' %}success{% elif driver.status == 'on_trip' %}primary{% else %}secondary{% endif %}">
                                        {{ driver.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if driver.active_trip %}
                                        <a href="{% url 'trip_detail' driver.active_trip.id %}">Trip #{{ driver.active_trip.id }}</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="last-updated">
                                    {% if driver.location %}
                                        {{ driver.location.last_updated|date:"M d, Y H:i:s" }}
                                    {% else %}
                                        Not available
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary locate-driver" data-driver-id="{{ driver.id }}">Locate</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No active drivers found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- No need to add styles here anymore as they're in the base template -->

<script>
    // Initialize map variables
    let map;
    let markers = {};
    
    // Initialize map with basic configurations
    function initMap() {
        // Default center (Thiruvananthapuram coordinates)
        const defaultCenter = { lat: 8.4834, lng: 76.9198 };
        
        // Create map
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: defaultCenter,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        
        // Add static markers for testing
        addStaticMarkers();
    }
    
    // Add static test markers to verify map is working
    function addStaticMarkers() {
        // Just add a test marker at center location
        const marker = new google.maps.Marker({
            position: { lat: 8.4834, lng: 76.9198 },
            map: map,
            title: "Test Marker"
        });
        
        // Add click event for the marker
        marker.addListener('click', function() {
            alert('Test marker clicked!');
        });
    }
    
    // Just wire up the locate buttons for simple functionality
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.locate-driver').forEach(function(button) {
            button.addEventListener('click', function() {
                alert('This would locate the driver on the map if data was available.');
            });
        });
        
        // Fix for Google Maps re-rendering when window is resized
        window.addEventListener('resize', function() {
            google.maps.event.trigger(map, 'resize');
        });
        
        // Fix for Google Maps in tabs
        if (map) {
            setTimeout(function() {
                google.maps.event.trigger(map, 'resize');
                // Re-center the map if needed
                if (map.getCenter()) {
                    map.setCenter(map.getCenter());
                }
            }, 100);
        }
    });
</script>

<!-- Load the Google Maps API script -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
{% endblock %}